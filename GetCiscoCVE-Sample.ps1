# Clear all Used Variables
$url=''
$postdata=''
$content=''
$auth_response=''
$url='https://cloudsso.cisco.com/as/token.oauth2'

$postdata = @{client_id='k938k64baab99tv23hg68zge';client_secret='S9yjKJ2XvhFPymGUz5v2GpNP';grant_type='client_credentials'}

$content ='application/x-www-form-urlencoded'

$auth_response = Invoke-RestMethod -URI $url -Method Post -Body $postdata -ContentType $content

Write-Host $auth_response
$auth_response.access_token

$hdrs = @{}
   $hdrs.Add("Accept","application/json")
   $hdrs.Add("Authorization","Bearer $($auth_response.access_token)")

$hdrs

$outFile = ".\test.csv"
# Delete file if exist
if (Test-Path $outFile) 
{
  Remove-Item $outFile
}

# obtain the latest 10 advisories
$pathToJsonFile = ".\result.json"
$pathToOutputFile = ".\result.csv"
$url = "https://api.cisco.com/security/advisories/latest/10"
Invoke-RestMethod -Uri $url -Method GET -Headers $hdrs | ConvertTo-Json -depth 100 | Out-File $pathToJsonFile
# $result.advisories.count
# $result.advisories
# $result.advisories | Export-Csv ".\output.csv" -notype -append

$json = (Get-Content -Path $pathToJsonFile | ConvertFrom-Json)
# $json.advisories | ConvertTo-Csv -NoTypeInformation | Set-Content $pathToOutputFile

# Create the DataTable
$dataTable = New-Object System.Data.DataTable
$dataTable.Columns.Add("advisoryId") | Out-Null
$dataTable.Columns.Add("advisoryTitle") | Out-Null
$dataTable.Columns.Add("bugIDs") | Out-Null
$dataTable.Columns.Add("ipsSignatures") | Out-Null
$dataTable.Columns.Add("cves") | Out-Null
$dataTable.Columns.Add("cvrfUrl") | Out-Null
$dataTable.Columns.Add("ovalUrl") | Out-Null
$dataTable.Columns.Add("cvssBaseScore") | Out-Null
$dataTable.Columns.Add("cwe") | Out-Null
$dataTable.Columns.Add("firstPublished") | Out-Null
$dataTable.Columns.Add("lastUpdated") | Out-Null
$dataTable.Columns.Add("productNames") | Out-Null
$dataTable.Columns.Add("publicationUrl") | Out-Null
$dataTable.Columns.Add("sir") | Out-Null
$dataTable.Columns.Add("summary") | Out-Null


# $json.advisories
$json.advisories | ForEach-Object {
	$_.advisoryId
	$_.bugIDs.count
	$bugsID = ""
	$ipsSignatures = ""
	$cves = ""
	$ovalUrl = ""

	$dataRow = $dataTable.NewRow()
		
	$dataRow["advisoryId"] = $_.advisoryId
	$dataRow["bugIDs"] = $_.bugIDs -join ";"
	$dataRow["ipsSignatures"] = $_.ipsSignatures -join ";"
	$dataRow["cves"] = $_.cves -join ";"
	$dataRow["cvrfUrl"] = $_.cvrfUrl
	$dataRow["ovalUrl"] = $_.ovalUrl -join ";"
	$dataRow["cvssBaseScore"] = $_.cvssBaseScore
	$dataRow["cwe"] = $_.cwe -join ";"
	$dataRow["firstPublished"] = $_.firstPublished
	
	$dataTable.Rows.Add($dataRow)
}

$dataTable | Export-Csv -NoType -Append $outFile

$filename = ".\result.xlsx"
# Delete file if exist
if (Test-Path $filename) 
{
  Remove-Item $filename
}
$dataTable | Select advisoryId, bugIDs, ipsSignatures, cves, cvrfUrl, ovalUrl, cvssBaseScore, cwe, firstPublished | 
	Export-Excel $filename -AutoSize -WorkSheetname "Services" -BoldTopRow -TableName "Services" -TableStyle "Light1"